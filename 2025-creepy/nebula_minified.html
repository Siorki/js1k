<!doctype html>

<head>
<title>work in progress ~ js1024</title>
<meta name="author" content="author">
<meta name="description" content="description">
<meta name="title" content="title">
<meta charset=utf-8>
</head>

<body id=b>
<canvas id=a></canvas>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    #a {
        position: relative;
        display: block;
    }
    
    .play {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translateX(-50%)translateY(-50%);
        font-size: 30px;
        font-family: arial, sans-serif;
        background: #f3f4f5;
        padding: 15px;
        border: 2px solid #ddd;
        border-radius: 5px;
    }
    
    /* for mobile */
    :root {
        touch-action: pan-x pan-y;
        height: 100%;
    }
</style>

<script>
    // Entry configuration
    // ===================

    var title = "title";

    // Shim setup and polyfills (do not edit)
    // ======================================

    a = document.getElementById("a");
    a.width = innerWidth;
    a.height = innerHeight;

    b = document.getElementById("b");

    c = a.getContext("2d");
    d = document;

    var M = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent); // detects if the user is on mobile

    if (M) {
        a.oncontextmenu = function(e) {
                e.preventDefault();
            } // prevents context menu on mobile
    }

    window.AudioContext = window.AudioContext || window.webkitAudioContext;
    window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
    a.requestPointerLock = a.requestPointerLock || a.mozRequestPointerLock || a.webkitRequestPointerLock;
    navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
    if (typeof OscillatorNode !== 'undefined' && OscillatorNode.prototype) {
        OscillatorNode.prototype.start = OscillatorNode.prototype.start || OscillatorNode.prototype.noteOn;
        OscillatorNode.prototype.stop = OscillatorNode.prototype.stop || OscillatorNode.prototype.noteOff;
    }

    // Add a start button if sound is present in the code
    onload = () => {
        var entry_code = entry.innerText;
        var has_sound = false;
        if(entry_code.includes('eval')) {
            try {
                parent.eval(entry_code.replace(/eval\(/g, 'throw(').replace(/eval\`/g, 'throw`'));
            }
            catch(e){
                entry_code = e;
            }
        }
        
        try {
        if(entry_code.includes("AudioContext")||entry_code.includes("Oscillator")||entry_code.includes("speak")||entry_code.includes("play")||entry_code.includes("autoplay")){
            b.insertAdjacentHTML("beforeEnd", "<button class='play' onclick='start_demo(this)'>PLAY</button>");
        } else {
            parent.eval(entry.innerText);
        }
        } catch(e) {
            // I have no idea what this does but I think it will make demos that contain eval naturally (no compressor used) work
            entry_code = entry.innerText;
            parent.eval(entry_code);
        }
    };

    // Makes the "window." be optional in the demo code
    function start_demo(button) {
        console.log(entry.innerText);
        parent.eval(entry.innerText);
        button.remove();
    }

    console.log(
        a, // canvas
        b, // body
        c, // 2D canvas context
        d // document
    );
</script>

<script type=text id=entry>
// Your entry goes here ðŸ‘‡
// =======================

	
// inspired by https://en.wikipedia.org/wiki/Main_sequence#/media/File:LH_95.jpg


// canvas a2 : holds the reference galaxy images. Stars on top half, nebula on bottom half
a2 = document.createElement("canvas");
a2.width = a2.height = 4000;
c2 = a2.getContext("2d");


// canvas a4 : contains a single cloud for the black hole. Used to speed up rendering (image copy faster than creating multiple gradients)
a4 = document.createElement("canvas");
a4.width = a4.height = 512;
c4 = a4.getContext("2d");

c2.fillStyle="#000";
c2.fillRect(0,0,4000,4000);
for (i=2000; --i; ) { // draw stars

  x = 2400*Math.random();
  y = 1900*Math.random();
  s = Math.random();
  s =s*s*8;
  k = Math.random();
  k = k*k; // more orange stars than blue ones
  // 0          .25        .5         .75    1
  // orange              white             blue
  r = 100;
  l = 100-60*Math.abs(k-.5);
  h = k>.5 ? 200 : 30;
  w = c2.createRadialGradient(x, y, s/4, x, y, s);
  w.addColorStop(0, "hsl("+[h,(r|0)+"%",(l|0)+"%)"]);
  w.addColorStop(1, "#0000");
  c2.fillStyle = w;
  c2.fillRect(x-s,y-s,s*2,s*2);
}
for (i=2000; --i; ) { // draw nebula

  x = 2400*Math.random();
  y = 1900*Math.random()+2000;
  s = 48;//Math.random();
  k=(1-Math.cos(x/96))/2;
  // 0          .25        .5         .75    1
  // blue #080C10            gray                 orange #140E08
  l = 5;
  r = 100*Math.abs(k-.5);
  h = k>.5 ? 200 : 30;
  w = c2.createRadialGradient(x, y, s/4, x, y, s);
  w.addColorStop(0, "hsl("+[h,(r|0)+"%",(l|0)+"%)"]);
  w.addColorStop(1, "#0000");
  c2.fillStyle = w;
  c2.fillRect(x-s,y-s,s*2,s*2);
}





z = []; // time, angle
for (i=-3000; t=i; ++i)
	z.push([i, 6.28*Math.random()]);
w = c4.createRadialGradient(32, 32, 16, 32, 32, 32);
w.addColorStop(0, "#140e08");
w.addColorStop(1, "#000000");
c4.fillStyle = w;
c4.fillRect(0,0,64,64);


setInterval( () => {
	c.globalCompositeOperation="source-over";
	c.fillStyle="#000";
	c.fillRect(0,0,innerWidth, innerHeight);
	c.globalCompositeOperation="lighter";
	
	// black hole accretion disk, made of 3000 clouds
	for (i of z) {
		r = Math.max(24, 240-4*Math.sqrt(t-i[0]));	// cloud radius
		g = i[1]-=1/r;	// cloud angle
		s = Math.min(8+r/20, (t-i[0])/8); // cloud size
		c.drawImage(a4, 0, 0, 64, 64, Math.max(0, 2500-t)+innerWidth/2+(r*Math.cos(g)-s)*innerWidth/512, innerHeight/2+(r*Math.sin(g)-s*2)*innerWidth/512/2-300*Math.sin(Math.min(2500,t)/800), s*2*innerWidth/512, s*2*innerWidth/512);
	};
	
	// center of the black hole
	c.globalCompositeOperation="source-over";
	c.beginPath();
	c.arc(Math.max(0, 2500-t)+innerWidth/2, innerHeight/2-300*Math.sin(Math.min(2500,t)/800), innerWidth/40, 3.2, 0);
	c.fill();
	
	// galaxy
	c.globalCompositeOperation="lighter";
	for (i=1; i<5; ++i) 
		c.drawImage(a2, t, 300*(i&3)+300*Math.sin(t/800), innerWidth/i, innerHeight/i, 0, 0, innerWidth, innerHeight);

	for (i=2; i<20; ++i) 
		c.drawImage(a2, t, 2000+300*(i&3)+300*Math.sin(t/800), innerWidth/i, innerHeight/i, 0, 0, innerWidth, innerHeight);

	// spaceship
	x=200;y=600;
	w = c.createRadialGradient(x, y-300*Math.sin(Math.min(2500,t)/800), 0, x, y-300*Math.sin(Math.min(2500,t)/800), 200);
	w.addColorStop(0, "#ff8");
	w.addColorStop(.1, "#a62");
	w.addColorStop(1, "#000000");
	c.fillStyle = w;
	c.fillRect(0,y-300*Math.sin(Math.min(2500,t)/800),x,2);
	x-=20*Math.sin(t/80);y-=20;
	w = c.createRadialGradient(x, y-300*Math.sin(Math.min(2500,t)/800), 0, x, y-300*Math.sin(Math.min(2500,t)/800), 200);
	w.addColorStop(0, "#ff8");
	w.addColorStop(.1, "#a62");
	w.addColorStop(1, "#000000");
	c.fillStyle = w;
	c.fillRect(0,y-300*Math.sin(Math.min(2500,t)/800),x,2);
	
	z[t%3000][0] = t;
	++t;
	
}, 40)

 
// =======================
</script>
</body>
